version: "2.1"
description: "Install and cache openjdk on machine executor"

commands:
  openjdk:
    parameters:
      version:
        type: integer
        default: 8
    steps:
      - run:
          name: Prepare temp directory
          command: mkdir /tmp/archives
      - run:
          name: Generate cache version
          command: |
            apt-cache policy openjdk-<< parameters.version >>-jdk | grep 'Candidate:' | cut -d' ' -f4 >> .openjdk_version
            cat .openjdk_version
      - restore_cache:
          keys:
          - apt-cache-{{ checksum ".openjdk_version" }}
      - run:
          name: Restore apt cache
          command: sudo rsync -av /tmp/archives/ /var/cache/apt/archives/
      - run:
          name: Switch to US mirror
          command: sudo sed -i 's/archive.ubuntu.com/us.archive.ubuntu.com/g' /etc/apt/sources.list
      - run:
          name: Install openjdk-<< parameters.version >>-jdk
          command: |
            sudo add-apt-repository ppa:openjdk-r/ppa
            sudo apt update -q
            sudo apt install -qy openjdk-<< parameters.version >>-jdk
            sudo update-java-alternatives --set java-1.<< parameters.version >>.0-openjdk-amd64
      - run:
          name: Prepare to save apt cache
          command: rsync -av /var/cache/apt/archives/*.deb /tmp/archives/
      - save_cache:
          key: apt-cache-{{ checksum ".openjdk_version" }}
          paths:
          - /tmp/archives
