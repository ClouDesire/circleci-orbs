description: "Execute Kitchen Test Suites"
parameters:
  suites:
    type: string
    default: ""
  concurrency:
    type: boolean
    default: true
  converge_number:
    type: integer
    default: 1
  additional_steps:
    description: optional steps to execute after the default test execution
    type: steps
steps:
  - run:
      name: Run tests
      enviroment:
        PARAM_KITCHEN_SUITES: << parameters.suites >>
        PARAM_KITCHEN_CONCURRENCY: << parameters.concurrency >>
        CONVERGE_NUMBER: << parameters.converge_number >>
      command: <<include(scripts/cookbooks_test.sh)>>
  - steps: << parameters.additional_steps >>
  - store_test_results:
      path: /tmp/results/
  - store_artifacts:
      path: .kitchen/logs
      destination: kitchen-logs
  - run:
      name: Show debug output
      command: chef exec kitchen list
      when: on_fail
  - run:
      name: Clean resources
      environment:
        PARAM_KITCHEN_SUITES: << parameters.suites >>
        PARAM_KITCHEN_CONCURRENCY: << parameters.concurrency >>
      command: <<include(scripts/cookbooks_cleanup.sh)>>
      when: always
