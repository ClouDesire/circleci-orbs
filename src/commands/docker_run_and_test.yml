---
description: >
  Command to run and test a docker container
parameters:
  container_name:
    type: string
  container_port_range:
    type: string
    default: "8080:8080"
  container_env_vars_file:
    type: string
    default: "./docker_env_file.list"
  container_check_url:
    type: string
    default: http://localhost:8080/actuator/health
  container_check_sleep_time:
    type: integer
    default: 60
  docker_registry:
    type: string
    default: docker.io
  docker_cmd_additional_options:
    type: string
    default: ""
steps:
  - run:
      name: Execute container
      command: |
        DOCKER_CMD_OPTIONS=<<parameters.docker_cmd_additional_options>>
        if [ -f "<<parameters.container_env_vars_file>>" ]; then
          DOCKER_CMD_OPTIONS="$DOCKER_CMD_OPTIONS --env-file <<parameters.container_env_vars_file>>"
        fi

        docker run -d --name <<parameters.container_name>> -p '<<parameters.container_port_range>>' "${DOCKER_CMD_OPTIONS}" <<parameters.docker_registry>>/<<parameters.container_name>>
  - run:
      name: Wait startup
      command: |
        for i in $(seq 1 30); do
          if [ $i -gt 1 ] && sleep <<parameters.container_check_sleep_time>>; then
            curl -sSf <<parameters.container_check_url>> && s=0 && break || s=$?;
          fi
        done;
        exit $s
  - run:
      name: Print container logs
      when: on_fail
      command: docker logs <<parameters.container_name>>
