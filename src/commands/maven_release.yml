---
description: >
  Execute release of a maven project.
parameters:
  project_dir:
    type: string
    default: .
  settings_file:
    description: Specify a path to a custom settings file to use
    type: string
    default: "$GIT_CI_CONF_DIR/mvn/settings.xml"
  ssh_fingerprint:
    type: string
    default: 08:24:83:a8:59:c5:7d:d5:de:b3:15:bf:1a:50:0e:ca
steps:
  - add_ssh_keys:
      fingerprints:
        - "<< parameters.ssh_fingerprint >>"
  - git_checkout:
      url: "git@github.com:ClouDesire/ci-conf.git"
  - run:
      name: Setup custom settings.xml
      command: |
        FILE="<< parameters.settings_file >>"
        if [ -f "$FILE" ]; then
          mkdir -v -p ~/.m2
          cp -v $FILE ~/.m2
        else
          echo $FILE not found
        fi
  - run:
      name: "Release project"
      environment:
        PROJECT_DIR: << parameters.project_dir >>
      command: <<include(scripts/maven_release.sh)>>
  - slack/notify:
      channel: "dev"
      custom: |
        {
          "text": ":rocket: `${CIRCLE_PROJECT_REPONAME}`: `v${RELEASE_VERSION}` released",
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": ":rocket: `${RELEASE_VERSION}`: `v${CIRCLE_PROJECT_REPONAME}` released"
              }
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "CircleCI Build"
                  },
                  "url": "${CIRCLE_BUILD_URL}"
                },
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "Github PR"
                  },
                  "url": "${CIRCLE_PULL_REQUEST}"
                }
              ]
            }
          ]
        }
      event: pass
