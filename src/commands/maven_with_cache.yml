---
description: Run a set of steps with Maven dependencies cached.
parameters:
  force_download:
    description: Wheter to preemptively download all dependencies
    type: boolean
    default: true
  mvn_path:
    description: Specify a custom path to maven
    type: string
    default: mvn
  settings_file:
    description: Specify a path to a custom settings file to use
    type: string
    default: "$REPO_DIR/ci-conf/mvn/settings.xml"
  steps:
    description: Commands to execute between cache restore and save
    type: steps
steps:
  - run:
      name: Generate Cache Checksum
      command: find . -name 'pom.xml' | sort | xargs cat > /tmp/maven_cache_seed
  - restore_cache:
      key: maven-{{ checksum "/tmp/maven_cache_seed" }}
  - run:
      name: Setup custom settings.xml
      command: |
        FILE="<< parameters.settings_file >>"
        if [ -f "$FILE" ]; then
          mkdir -v -p ~/.m2
          cp -v $FILE ~/.m2
        fi
  - when:
      condition: << parameters.force_download >>
      steps:
        - run:
            name: Install Dependencies
            command: << parameters.mvn_path >> dependency:go-offline
  - steps: << parameters.steps >>
  - save_cache:
      paths:
        - ~/.m2
      key: maven-{{ checksum "/tmp/maven_cache_seed" }}
